name: Keycloak Automation Tests

on:
  workflow_dispatch: # Allow manual triggering
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  test:
    # Using self-hosted runner on your Mac device
    runs-on: self-hosted
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Install Playwright browsers
      run: npx playwright install chromium
      
    - name: Install Allure CLI
      run: |
        npm install -g allure-commandline || true
        mkdir -p allure-results
        
    - name: Run Playwright tests
      run: |
        npx playwright test --project=chromium --reporter=line,allure-playwright
      continue-on-error: true
      env:
        KEYCLOAK_USERNAME: ${{ secrets.KEYCLOAK_USERNAME }}
        KEYCLOAK_PASSWORD: ${{ secrets.KEYCLOAK_PASSWORD }}
        KEYCLOAK_URL: ${{ secrets.KEYCLOAK_URL }}
        
    - name: Generate Allure Report
      if: always()
      run: |
        allure generate allure-results --clean --output allure-report || true
        
    - name: Copy report to project directory
      if: always()
      run: |
        # Copy report to the main project for easy access
        cp -r allure-report ${{ github.workspace }}/../allure-report-latest || true
        echo "ðŸ“Š Allure report available at: ~/actions-runner/_work/playwright-test-automation-limajariUI/allure-report-latest"
        
    - name: Open Allure Report (Local)
      if: always()
      run: |
        # Display where report is located
        echo "=============================================="
        echo "âœ… TEST COMPLETED!"
        echo "=============================================="
        echo "ðŸ“‚ Allure Report: $(pwd)/allure-report"
        echo "ðŸ“‚ Playwright Report: $(pwd)/playwright-report"
        echo "ðŸ“‚ Test Results: $(pwd)/test-results"
        echo "=============================================="
        echo ""
        echo "To view reports locally, run:"
        echo "  allure open $(pwd)/allure-report"
        echo "  OR"
        echo "  npx playwright show-report $(pwd)/playwright-report"
        echo "=============================================="

    - name: Show Test Summary
      if: always()
      run: |
        echo "ðŸ“‹ Test Results Summary:"
        cat test-results/.last-run.json 2>/dev/null || echo "No test results found"
